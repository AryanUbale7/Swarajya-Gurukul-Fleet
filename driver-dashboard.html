<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swarajya Gurukul | Driver Dashboard</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --sidebar-bg: #0f172a;
            --bg: #f8fafc;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --card-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: var(--bg); color: var(--text-main); display: flex; min-height: 100vh; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 280px; background: var(--sidebar-bg); color: white; padding: 35px 24px;
            position: fixed; height: 100vh; display: flex; flex-direction: column; z-index: 100;
            align-items: center;
        }
        
        .school-logo { 
            width: 90px; 
            height: 90px; 
            object-fit: contain;
            margin-bottom: 15px;
        }

        .logo-text { 
            font-size: 18px; 
            font-weight: 800; 
            color: #fbbf24; 
            letter-spacing: 0.5px;
            margin-bottom: 40px;
            text-align: center;
        }

        .nav-group { width: 100%; flex: 1; }
        .nav-item {
            padding: 14px 18px; border-radius: 14px; margin-bottom: 10px; cursor: pointer;
            display: flex; align-items: center; gap: 14px; transition: 0.3s; color: #94a3b8; text-decoration: none;
        }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: var(--primary); box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3); }

        /* --- MAIN CONTENT --- */
        .main { margin-left: 280px; width: calc(100% - 280px); padding: 40px 50px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 20px; box-shadow: var(--card-shadow); border: 1px solid #f1f5f9; }
        .stat-card h3 { font-size: 13px; color: var(--text-muted); margin-bottom: 5px; }
        .stat-card p { font-size: 22px; font-weight: 800; color: var(--primary); }

        .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        .card { background: white; padding: 25px; border-radius: 28px; border: 1px solid #f1f5f9; box-shadow: var(--card-shadow); margin-bottom: 25px; }
        .card-title { font-size: 18px; font-weight: 800; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }

        .calendar-controls { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .month-select { padding: 8px 12px; border-radius: 10px; border: 1px solid #e2e8f0; font-weight: 700; background: #f8fafc; color: var(--primary); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); border: 1px solid #f1f5f9; border-radius: 15px; overflow: hidden; }
        .day { aspect-ratio: 1.5; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 0.5px solid #f1f5f9; font-size: 14px; transition: 0.2s; }
        .day.present { background: #ecfdf5; color: #059669; font-weight: 700; position: relative; }
        .day.present::after { content: 'âœ“'; position: absolute; bottom: 2px; font-size: 10px; }
        .day.absent { background: #fee2e2; color: #e11d48; font-weight: 700; }
        .day.active { background: var(--primary) !important; color: white !important; border-radius: 8px; }

        .action-box { display: none; background: #f8fafc; padding: 15px; border-radius: 15px; margin-top: 15px; border: 1px solid #e2e8f0; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-p { background: var(--primary); color: white; }
        .btn-a { background: #fee2e2; color: #e11d48; }

        .staff-card { background: #eef2ff; padding: 15px; border-radius: 15px; border: 1px solid #e0e7ff; display: flex; align-items: center; gap: 12px; margin-top: 15px; }
        .staff-avatar { width: 40px; height: 40px; border-radius: 10px; background: white; display: grid; place-items: center; }

        .log-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .status-badge { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 800; }
        .p-badge { background: #dcfce7; color: #15803d; }
    </style>
</head>
<body>

<div class="sidebar">
    <img src="school-logo.png" alt="Swarajya Gurukul" class="school-logo">
    <div class="logo-text">SWARAJYA GURUKUL</div>
    
    <div class="nav-group">
        <a href="driver-dashboard.html" class="nav-item active"><i data-lucide="layout-dashboard"></i> My Dashboard</a>
        <a href="trip-history.html" class="nav-item"><i data-lucide="map-pin"></i> Trip History</a>
        <a href="profile-settings.html" class="nav-item"><i data-lucide="user-cog"></i> Profile Settings</a>
    </div>
    
    <div class="nav-item" onclick="logout()" style="margin-top: auto; color: #f43f5e; width: 100%;"><i data-lucide="log-out"></i> Logout</div>
</div>

<div class="main">
    <div class="top-bar">
        <div>
            <h1 style="font-size: 28px; font-weight: 800;">Welcome, <span id="headerDriverName">Driver</span>!</h1>
            <p style="color: var(--text-muted); font-size: 14px;">Monitor your bus status and mark daily duty.</p>
        </div>
        <div style="background: white; padding: 8px 20px; border-radius: 50px; box-shadow: var(--card-shadow); display: flex; align-items: center; gap: 10px;">
            <img id="dPhoto" src="" style="width:35px; height:35px; border-radius:50%; border:2px solid var(--primary);">
            <strong id="dNameLabel" style="font-size: 14px;">Name</strong>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><h3>Fuel Level</h3><p>78%</p></div>
        <div class="stat-card"><h3>Engine Health</h3><p style="color:#10b981;">Good</p></div>
        <div class="stat-card"><h3>Today's Trips</h3><p>04</p></div>
        <div class="stat-card"><h3>Next Service</h3><p style="font-size: 16px;">15 Mar 2026</p></div>
    </div>

    <div class="grid">
        <div class="left-col">
            <div class="card">
                <div class="card-title"><i data-lucide="calendar"></i> Attendance Portal</div>
                <div class="calendar-controls">
                    <select id="monthSelect" class="month-select" onchange="renderCalendar()"></select>
                    <select id="yearSelect" class="month-select" onchange="renderCalendar()"></select>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>
                
                <div id="actionBox" class="action-box">
                    <p id="selDateTxt" style="font-weight: 700; font-size: 13px; margin-bottom: 10px;"></p>
                    <div class="btn-group">
                        <button class="btn btn-p" onclick="saveDuty('Present')">Mark Present</button>
                        <button class="btn btn-a" onclick="saveDuty('Absent')">Mark Absent</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-col">
            <div class="card">
                <div class="card-title"><i data-lucide="bus"></i> Vehicle & Staff</div>
                <div style="background: #f8fafc; padding: 20px; border-radius: 20px; border: 1px solid #f1f5f9; text-align: center;">
                    <small style="color: var(--text-muted); font-weight: 700; font-size: 10px; text-transform: uppercase;">Assigned Bus</small>
                    <div id="busID" style="font-size: 36px; font-weight: 900; color: var(--primary);">--</div>
                </div>

                <div class="staff-card">
                    <div class="staff-avatar"><i data-lucide="sparkles" style="color: var(--primary); width: 20px;"></i></div>
                    <div>
                        <small style="display: block; color: var(--primary); font-weight: 800; font-size: 9px; text-transform: uppercase;">Bus Cleaner</small>
                        <span style="font-weight: 700; font-size: 14px;">Raju (Helper)</span>
                    </div>
                    <div style="margin-left: auto;">
                        <span id="cStatus" class="status-badge" style="background:#f1f5f9; color:#94a3b8;">Offline</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title" style="font-size: 16px;"><i data-lucide="clock"></i> Recent Activity</div>
                <div id="logItems"></div>
            </div>
        </div>
    </div>
</div>

<script>
    lucide.createIcons();
    const driver = JSON.parse(localStorage.getItem("currentDriver"));
    
    // Redirect to Unified Login if no driver session
    if (!driver) window.location.href = "login.html";

    document.getElementById('headerDriverName').innerText = driver.name;
    document.getElementById('dNameLabel').innerText = driver.name;
    document.getElementById('busID').innerText = driver.bus;
    document.getElementById('dPhoto').src = driver.photo;

    const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const mSelect = document.getElementById('monthSelect');
    const ySelect = document.getElementById('yearSelect');
    months.forEach((m, i) => mSelect.innerHTML += `<option value="${i}">${m}</option>`);
    const cy = new Date().getFullYear();
    for(let y=cy-1; y<=cy+1; y++) ySelect.innerHTML += `<option value="${y}">${y}</option>`;
    mSelect.value = new Date().getMonth();
    ySelect.value = cy;

    let selectedDateStr = "";

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = "";
        const m = parseInt(mSelect.value);
        const y = parseInt(ySelect.value);
        const firstDay = new Date(y, m, 1).getDay();
        const days = new Date(y, m + 1, 0).getDate();
        const history = JSON.parse(localStorage.getItem("history_" + driver.id)) || [];

        for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="day" style="visibility:hidden"></div>`;

        for(let d=1; d<=days; d++) {
            const dateStr = `${d}/${m+1}/${y}`;
            const record = history.find(r => r.date === dateStr);
            let status = record ? record.status.toLowerCase() : "";
            grid.innerHTML += `<div class="day ${status}" onclick="pickDate(this, ${d})">${d}</div>`;
        }
        document.getElementById('actionBox').style.display = 'none';
    }

    function pickDate(el, d) {
        document.querySelectorAll('.day').forEach(day => day.classList.remove('active'));
        el.classList.add('active');
        selectedDateStr = `${d}/${parseInt(mSelect.value)+1}/${ySelect.value}`;
        document.getElementById('selDateTxt').innerText = "Update Duty: " + selectedDateStr;
        document.getElementById('actionBox').style.display = 'block';
    }

    function saveDuty(status) {
        const driverId = Number(driver.id); 
        let history = JSON.parse(localStorage.getItem("history_" + driverId)) || [];
        const now = new Date();
        const today = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()}`;
        const finalDate = selectedDateStr || today;

        history = history.filter(r => r.date !== finalDate);
        history.unshift({ date: finalDate, status: status, reason: status === 'Present' ? 'On Duty' : 'On Leave' });
        
        localStorage.setItem("history_" + driverId, JSON.stringify(history));
        renderCalendar();
        updateLogs();
    }

    function updateLogs() {
        const history = JSON.parse(localStorage.getItem("history_" + driver.id)) || [];
        const logContainer = document.getElementById('logItems');
        logContainer.innerHTML = history.slice(0, 4).map(item => `
            <div class="log-item">
                <span style="font-weight:700;">${item.date}</span>
                <span class="status-badge ${item.status === 'Present' ? 'p-badge' : 'absent'}" 
                      style="${item.status === 'Absent' ? 'background:#fee2e2; color:#e11d48' : ''}">
                    ${item.status}
                </span>
            </div>
        `).join('');
        
        const today = `${new Date().getDate()}/${new Date().getMonth() + 1}/${new Date().getFullYear()}`;
        const cStatus = localStorage.getItem("cleaner_present_" + driver.id) === today ? "Present" : "Offline";
        const cLabel = document.getElementById('cStatus');
        cLabel.innerText = cStatus;
        cLabel.style.background = cStatus === "Present" ? "#dcfce7" : "#f1f5f9";
        cLabel.style.color = cStatus === "Present" ? "#15803d" : "#94a3b8";
    }

    // Fixed Logout to point to login.html
    function logout() { 
        localStorage.removeItem("currentDriver"); 
        window.location.href = "login.html"; 
    }

    renderCalendar();
    updateLogs();
    setInterval(updateLogs, 5000);
</script>
</body>
</html>