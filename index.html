<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swarajya Gurukul | Admin Dashboard</title>
    
    <script>
        const userToken = localStorage.getItem("token");
        if (!userToken || userToken === null) {
            window.location.replace("login.html");
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --bg-body: #f3f4f6;
            --sidebar-bg: #ffffff; --text-main: #0f172a; --text-muted: #64748b;
            --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; min-height: 100vh; }

        .sidebar { width: 280px; background: var(--sidebar-bg); padding: 32px 20px; border-right: 1px solid #e2e8f0; position: fixed; height: 100vh; display: flex; flex-direction: column; z-index: 1000; }
        .logo-container { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 40px; text-decoration: none; color: inherit; text-align: center; }
        .school-logo { width: 80px; height: 80px; object-fit: contain; }
        .logo-text { font-size: 16px; font-weight: 800; color: #b8860b; }

        .nav-item { padding: 12px 16px; margin-bottom: 6px; border-radius: 12px; cursor: pointer; transition: 0.3s; font-weight: 600; color: var(--text-muted); display: flex; align-items: center; gap: 12px; text-decoration: none; }
        .nav-item:hover, .nav-item.active { background: #eef2ff; color: var(--primary); }

        .main { margin-left: 280px; flex: 1; padding: 40px 60px; }
        .cards-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
        .card { background: white; padding: 24px; border-radius: 20px; box-shadow: var(--card-shadow); border: 1px solid #e2e8f0; }
        
        .charts-grid { display: grid; grid-template-columns: 1.6fr 1fr; gap: 24px; margin-bottom: 32px; }
        .chart-box { background: white; padding: 28px; border-radius: 24px; border: 1px solid #e2e8f0; height: 420px; box-shadow: var(--card-shadow); }
        
        .table-box { background: white; padding: 32px; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: var(--card-shadow); }
        /* Adjusted grid for Student boarding stats */
        .table-row { display: grid; grid-template-columns: 0.5fr 1fr 1fr 1fr 0.8fr 0.6fr; padding: 18px 12px; border-bottom: 1px solid #f1f5f9; align-items: center; }
        
        .status-pill { padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 700; display: inline-flex; align-items: center; gap: 4px; }
        .present { background: #dcfce7; color: #15803d; }
        .absent { background: #fee2e2; color: #b91c1c; }
        .waiting { background: #f1f5f9; color: #94a3b8; }
        .moving { background: #ecfdf5; color: #059669; }
    </style>
</head>
<body>

<div class="sidebar">
    <a href="index.html" class="logo-container">
        <img src="school-logo.png" alt="Swarajya Gurukul" class="school-logo">
        <span class="logo-text">SWARAJYA GURUKUL</span>
    </a>
    <nav class="nav-group">
        <a href="index.html" class="nav-item" id="nav-dash">
            <i data-lucide="layout-dashboard"></i> Dashboard
        </a>
        <a href="fleet.html" class="nav-item" id="nav-fleet">
            <i data-lucide="map"></i> Live Fleet
        </a>
        <a href="bus-health.html" class="nav-item" id="nav-health">
            <i data-lucide="heart-pulse"></i> Bus Health
        </a>
        <a href="routes.html" class="nav-item" id="nav-routes">
            <i data-lucide="route"></i> Routes
        </a>
        <a href="students.html" class="nav-item" id="nav-students">
            <i data-lucide="graduation-cap"></i> Students
        </a>
        <a href="driver-admin.html" class="nav-item" id="nav-driver">
            <i data-lucide="users"></i> Driver Monitor
        </a>
        <a href="manage-assignment.html" class="nav-item" id="nav-duty">
            <i data-lucide="user-cog"></i> Duty Assignments
        </a>
        <a href="settings.html" class="nav-item" id="nav-settings">
            <i data-lucide="settings"></i> Settings
        </a>
    </nav>
    <div class="sidebar-footer" style="margin-top:auto;"><div class="nav-item" onclick="logout()" style="color:#ef4444;"><i data-lucide="log-out"></i> Logout</div></div>
</div>

<main class="main">
    <header style="margin-bottom:40px;"><h1>Fleet Intelligence</h1><p>Real-time Student Boarding & Staff Monitoring</p></header>

    <div class="cards-grid">
        <div class="card"><span style="font-size:12px;color:var(--text-muted)">TOTAL STUDENTS</span><h2 id="totalCount">190</h2></div>
        <div class="card"><span style="font-size:12px;color:var(--text-muted)">PRESENT TODAY</span><h2 id="presentCount" style="color:#10b981">0</h2></div>
        <div class="card"><span style="font-size:12px;color:var(--text-muted)">ABSENT TODAY</span><h2 id="absentCount" style="color:#ef4444">0</h2></div>
        <div class="card"><span style="font-size:12px;color:var(--text-muted)">ACTIVE BUSES</span><h2>5</h2></div>
    </div>

    <div class="charts-grid">
        <div class="chart-box"><canvas id="areaChart"></canvas></div>
        <div class="chart-box"><canvas id="capacityChart"></canvas></div>
    </div>

    <div class="table-box">
        <div id="busTableBody"></div>
    </div>
</main>

<script src="students.js"></script>
<script>
    lucide.createIcons();

    const busData = [
        {id: 1, area: "Mira Road", status: "Moving"},
        {id: 2, area: "Bhayandar East", status: "Moving"},
        {id: 3, area: "Kashimira", status: "Arrived"},
        {id: 4, area: "Golden Nest", status: "Moving"},
        {id: 5, area: "Uttan", status: "Moving"}
    ];

    function logout() { localStorage.removeItem("token"); window.location.href = "login.html"; }

    function renderDashboard() {
        const tableBody = document.getElementById('busTableBody');
        const now = new Date();
        const todayStr = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()}`;

        tableBody.innerHTML = `
            <div class="table-row header" style="font-weight:700; color:var(--text-muted); font-size:11px; border-bottom: 2px solid #f1f5f9; margin-bottom: 10px;">
                <div>BUS ID</div>
                <div>DRIVER STAFF</div>
                <div>CLEANER STAFF</div>
                <div>BOARDING (P/A)</div>
                <div>ROUTE</div>
                <div>STATUS</div>
            </div>`;

        let totalPresent = 0;
        let totalAbsent = 0;

        busData.forEach(bus => {
            // Staff Logic
            const isCPresent = localStorage.getItem("cleaner_present_" + bus.id) === todayStr;
            const history = JSON.parse(localStorage.getItem("history_" + bus.id)) || [];
            const isDPresent = history.some(r => r.date === todayStr && r.status === 'Present');

            // Student Boarding Logic from shared students.js
            const busStudents = globalStudentData.filter(s => s.bus === "B-0" + bus.id);
            let p = 0, a = 0;
            busStudents.forEach(s => {
                const status = localStorage.getItem(`status_${s.id}_${todayStr}`);
                if(status === 'Present') p++;
                if(status === 'Absent') a++;
            });
            totalPresent += p;
            totalAbsent += a;

            tableBody.innerHTML += `
                <div class="table-row">
                    <div style="font-weight:700;">#B-0${bus.id}</div>
                    <div><span style="font-size:13px;font-weight:600;">Driver ${bus.id}</span><br><small class="status-pill ${isDPresent ? 'present' : 'waiting'}">${isDPresent ? 'Active' : 'Offline'}</small></div>
                    <div><span style="font-size:13px;font-weight:600;">Helper ${bus.id}</span><br><small class="status-pill ${isCPresent ? 'present' : 'waiting'}">${isCPresent ? 'On-Board' : 'Pending'}</small></div>
                    <div>
                        <b style="color:#10b981">${p}</b> / <b style="color:#ef4444">${a}</b>
                        <br><small style="color:var(--text-muted);font-size:9px;">Total: ${busStudents.length}</small>
                    </div>
                    <div style="color:var(--text-muted);font-size:12px;">${bus.area}</div>
                    <div><span class="status-pill moving">${bus.status}</span></div>
                </div>`;
        });

        document.getElementById('presentCount').innerText = totalPresent;
        document.getElementById('absentCount').innerText = totalAbsent;
    }

    function renderCharts() {
        const labels = busData.map(b => b.area);
        const counts = busData.map(b => globalStudentData.filter(s => s.bus === "B-0"+b.id).length);
        new Chart(document.getElementById('areaChart'), { type: 'bar', data: { labels: labels, datasets: [{ label: 'Total Students Assigned', data: counts, backgroundColor: '#6366f1', borderRadius: 8 }] }, options: { maintainAspectRatio: false } });
        new Chart(document.getElementById('capacityChart'), { type: 'doughnut', data: { labels: ['Present', 'Absent', 'Pending'], datasets: [{ data: [10, 5, 175], backgroundColor: ['#10b981', '#ef4444', '#e2e8f0'] }] }, options: { maintainAspectRatio: false, cutout: '75%' } });
    }

    window.onload = () => {
        renderDashboard();
        renderCharts();
        setInterval(renderDashboard, 3000); // Live sync every 3 seconds
    };
</script>
</body>
</html>